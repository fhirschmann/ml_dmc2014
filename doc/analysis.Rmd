```{r setup, echo=F}
library(knitr)
opts_chunk$set(echo=T, breaklines=T, fig.width=10, fig.path="figure-analysis/")
opts_knit$set(root.dir="../")
options(width=120)         
```

# DMC2014 Data Analysis

This document (``/svn/DMC14/R/trunk/doc/analyze.Rmd``) is available at
[http://dwxput6p.0x0b.de/analysis.html](http://dwxput6p.0x0b.de/analysis.html)
and is hooked onto the SVN. Please don't break the server.

## Helper functions/libraries needed for this Notebook
```{r echo=T, message=F, warning=F}
library(xtable)
library(ggplot2)
library(knitr)
library(lubridate)
library(vcd)

plot.ddens <- function(v1, v2, ...) {
    plot(density(v1, na.rm=T), col="blue", ...)
    lines(density(v2, na.rm=T), col="red")
    legend("topright", c("Train", "Test"), col = c("blue", "red"), lty = 1)
}
```

## Read in the Data
```{r}
dt.train <- read.csv("task/orders_train.txt", sep=";", na.strings=c("?", "??", "NA", ""))
dt.test <- read.csv("task/orders_class.txt", sep=";", na.strings=c("?", "??", "NA", ""))

dt.dates <- c("dateOfBirth", "creationDate", "orderDate", "deliveryDate")
dt.train[dt.dates] <- lapply(dt.train[dt.dates], as.Date)
dt.test[dt.dates] <- lapply(dt.test[dt.dates], as.Date)

dt.merged <- rbind(data.frame(dt.train, group="train"),
                   data.frame(dt.test, group="test", returnShipment=NA))
```

## General data Analysis

### Attribute #, Types, Factor Levels, ...

```{r}
str(dt.train)
str(dt.test)
```

### Missing Values

```{r}
nas.train <- as.data.frame(apply(dt.train, 2, function(x) sum(is.na(x)) / length(x)))
nas.test <- as.data.frame(apply(dt.test, 2, function(x) sum(is.na(x)) / length(x)))
nas <- merge(nas.train, nas.test, by="row.names")
colnames(nas) <- c("Attribute", "Missing (Train)", "Missing (Test)")
kable(nas)
```

## Individual Attribute Analysis

### orderItemID

This item is unique and thus serves no purpose in the Machine Learning process:

```{r}
with(dt.train, length(unique(orderItemID)) / length(orderItemID))
with(dt.test, length(unique(orderItemID)) / length(orderItemID))
```

### orderDate

#### orderMonth
```{r}
qplot(month(orderDate, label=T), fill=group, data=dt.merged, position="dodge", binwidth=1)
```


### deliveryDate

First, let's infer an attribute delivery time, which describes the time (in days)
the delivery has taken:

```{r}
dt.train$deliveryTime <- as.integer(dt.train$deliveryDate - dt.train$orderDate)
dt.test$deliveryTime <- as.integer(dt.test$deliveryDate - dt.test$orderDate)
```

And look for the obvious outliers:

```{r}
outl.train <- !is.na(dt.train$deliveryTime) & dt.train$deliveryTime < 0
outl.test <- !is.na(dt.test$deliveryTime) & dt.test$deliveryTime < 0

head(dt.train[outl.train, ])
```

Thesis: 1990-12-31 as deliveryDate for these outliers means that the delivery date
is not known.

```{r}
unique(dt.train[outl.train, ]$deliveryDate)
unique(dt.test[outl.test, ]$deliveryDate)
```

That's corret. So set them to NA:

```{r}
dt.train[outl.train, ]$deliveryDate <- NA
dt.train[outl.train, ]$deliveryTime <- NA
dt.test[outl.test, ]$deliveryDate <- NA
dt.test[outl.test, ]$deliveryTime <- NA
```

Plot it:

```{r}
par(mfrow=c(1, 2))

hist(dt.train$deliveryTime, main="Histogram of deliveryTime (Train)", xlab="Time (days)")
hist(dt.test$deliveryTime, main="Histogram of deliveryTime (Test)", xlab="Time (days)")
```

A kernel density estimate is probably better:

```{r}
plot.ddens(dt.train$deliveryTime, dt.test$deliveryTime,
           main="Kernel Density Estimate of Delivery Time", xlab="Time (days)")
plot.ddens(dt.train$deliveryTime, dt.test$deliveryTime, xlim=c(0, 40),
           main="Kernel Density Estimate of Delivery Time", xlab="Time (days)")
```

### itemID

### size

### color

### manufacturerID

### price

```{r}
plot.ddens(dt.train$price, dt.test$price, main="Kernel Density Estimate of Price",
           xlab="price (EUR)")
```

```{r}
plot.ddens(dt.train$price, dt.test$price, main="Kernel Density Estimate of Price",
           xlab="price (EUR)", xlim=c(0, 300))
```

### customerID

Is customerID unique?

```{r}
length(unique(dt.train$customerID)) / length(dt.train$customerID)
```

Not at all.

How large is the intersection?

```{r}
length(intersect(dt.train$customerID, dt.test$customerID))
```

Out of how many instances:
```{r}
nrow(dt.train)
nrow(dt.test)
```

So it does make sense to use it in some form.

### salutation

It's a women store:
```{r}
p <- t(rbind(prop.table(table(dt.train$salutation)),
             prop.table(table(dt.test$salutation))))
colnames(p) <- c("Contingency (Train)", "Contingency (Test)")
kable(p)
```

### dateOfBirth

We'll take a look at the histograms first:
```{r}
par(mfrow=c(1, 2))
barplot(table(dt.train$dateOfBirth), main="Histogram of dateOfBirth (Train)")
barplot(table(dt.test$dateOfBirth), main="Histogram of dateOfBirth (Test)")
```

Two points become obvious:
- Nobody lives that long.
- There is at least one DOB that appears unusually often in the two sets.

Which DOB appears that often?

```{r}
tail(sort(table(dt.train$dateOfBirth)))
tail(sort(table(dt.test$dateOfBirth)))
```

Set the dateOfBirth Attribute of these outliers to NA:

```{r}
outl.train <- with(dt.train, !is.na(dateOfBirth) & dateOfBirth %in% c(as.Date("1900-11-19"), as.Date("1949-11-19")))
outl.test <- with(dt.test, !is.na(dateOfBirth) & dateOfBirth %in% c(as.Date("1900-11-19"), as.Date("1949-11-19")))

dt.train[outl.train, ]$dateOfBirth <- NA
dt.test[outl.test, ]$dateOfBirth <- NA
```

Let's take a look again:

```{r}
par(mfrow=c(1, 2))
barplot(table(dt.train$dateOfBirth), main="Histogram of dateOfBirth (Train)")
barplot(table(dt.test$dateOfBirth), main="Histogram of dateOfBirth (Test)")
```

Looks alright.

But... what about the superhumans?

```{r}
head(sort(dt.test$dateOfBirth))
head(sort(dt.train$dateOfBirth))
```

Only three in the train set, so let's set them to NA as well:

```{r}
outl.train <- with(dt.train, !is.na(dateOfBirth) & dateOfBirth == as.Date("1655-04-19"))

dt.train[outl.train, ]$dateOfBirth <- NA
```

Let's compute an age attribute:

```{r}
dt.train$customerAge <- as.integer(2013 - year(dt.train$dateOfBirth))
dt.test$customerAge <- as.integer(2013 - year(dt.test$dateOfBirth))
```

And plot it:
```{r}
par(mfrow=c(1, 2))

hist(dt.train$customerAge, main="Customer Age (Train)")
hist(dt.test$customerAge, main="Customer Age (Test)")
```

There are still some outliers on both ends, so we set them to NA as well:

```{r}
outl.train <- with(dt.train, !is.na(customerAge) & (customerAge > 85 | customerAge < 19))
outl.test <- with(dt.test, !is.na(customerAge) & (customerAge > 85 | customerAge < 19))

dt.train[outl.train, ]$dateOfBirth <- NA
dt.train[outl.train, ]$customerAge <- NA

dt.test[outl.test, ]$dateOfBirth <- NA
dt.test[outl.test, ]$customerAge <- NA
```

Then we do a Quantile-Quantile plot against the normal distribution:
```{r}
par(mfrow=c(1, 2))

qqnorm(dt.train$customerAge, main="Customer Age Normal Q-Q Plot (Train)")
qqnorm(dt.test$customerAge, main="Customer Age Normal Q-Q Plot (Test)")
```

On the extremes, they are are not really normally distributed, but this will
have to do for now.

### state

```{r}
load(url("http://gadm.org/data/rda/DEU_adm1.RData"))
```

### creationDate

### returnShipment